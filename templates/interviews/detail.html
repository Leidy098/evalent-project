{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Entrevista: {{ interview.position }}</h2>
    <p><strong>Tipo:</strong> {{ interview.get_interview_type_display }}</p>
    <p><strong>Nivel:</strong> {{ interview.get_level_display }}</p>

    {% if interview.mode == "time" and interview.time_limit %}
    <div class="alert alert-info">
        <strong>Modo por tiempo:</strong> Tienes {{ interview.time_limit }} minutos.
        <br>
        Tiempo restante: <span id="timer"></span>
    </div>
    {% endif %}

    {% if interview.is_finished %}
        <div class="alert alert-success">
            ✅ La entrevista ha finalizado.
        </div>
        <div class="chat-box mb-3 p-3 border rounded bg-white shadow-sm"
             style="height: 450px; overflow-y: auto; background-color: #f8f9fa;">
            {% for msg in messages %}
                {% if msg.role == "user" %}
                    <div class="d-flex justify-content-end mb-2">
                        <div class="p-2 rounded-3" style="background-color: #0d6efd; color: white; max-width: 70%;">
                            <strong>Tú:</strong> {{ msg.content }}
                        </div>
                    </div>
                {% elif msg.role == "ai" %}
                    <div class="d-flex justify-content-start mb-2">
                        <div class="p-2 rounded-3" style="background-color: #495057; color: white; max-width: 70%;">
                            <strong>Entrevistador:</strong> {{ msg.content }}
                        </div>
                    </div>
                {% elif msg.role == "feedback" %}
                    <div class="d-flex justify-content-start mb-2">
                        <div class="p-2 rounded-3" style="background-color: #d1e7dd; color: #0f5132; max-width: 70%;">
                            <strong>Consejo:</strong> {{ msg.content }}
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <p class="text-muted">No hay mensajes aún.</p>
            {% endfor %}
        </div>
    {% else %}
        <div id="chat-box" class="chat-box mb-3 p-3 border rounded bg-white shadow-sm"
             style="height: 450px; overflow-y: auto; background-color: #f8f9fa;">
            {% for msg in messages %}
                {% if msg.role == "user" %}
                    <div class="d-flex justify-content-end mb-2">
                        <div class="p-2 rounded-3" style="background-color: #0d6efd; color: white; max-width: 70%;">
                            <strong>Tú:</strong> {{ msg.content }}
                        </div>
                    </div>
                {% elif msg.role == "ai" %}
                    <div class="d-flex justify-content-start mb-2">
                        <div class="p-2 rounded-3" style="background-color: #495057; color: white; max-width: 70%;">
                            <strong>Entrevistador:</strong> {{ msg.content }}
                        </div>
                    </div>
                {% elif msg.role == "feedback" %}
                    <div class="d-flex justify-content-start mb-2">
                        <div class="p-2 rounded-3" style="background-color: #d1e7dd; color: #0f5132; max-width: 70%;">
                            <strong>Consejo:</strong> {{ msg.content }}
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <p class="text-muted">No hay mensajes aún.</p>
            {% endfor %}
        </div>

        <form method="post" id="chat-form">
            {% csrf_token %}
            <div class="mb-3">
                <textarea name="answer" id="answer-input" class="form-control" rows="3"
                          placeholder="Escribe tu respuesta..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Responder</button>
            <button type="submit" name="finish" value="1" class="btn btn-danger">Finalizar entrevista</button>
        </form>
    {% endif %}
</div>

{% if interview.mode == "time" and interview.time_limit %}
<script>
    const limitMinutes = Number("{{ interview.time_limit|default:0 }}");
    const createdAt = new Date("{{ interview.created_at|date:'Y-m-d H:i:s' }}").getTime();
    const deadline = createdAt + (limitMinutes * 60 * 1000);

    function updateTimer() {
        const now = new Date().getTime();
        const remaining = deadline - now;

        if (remaining <= 0) {
            document.getElementById("timer").innerText = "Tiempo agotado";
            // marcar entrevista como finalizada vía backend
            fetch("{% url 'interviews:interview_finish' interview.pk %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                },
            }).then(() => location.reload());
            return;
        }

        const minutes = Math.floor((remaining / (1000 * 60)) % 60);
        const seconds = Math.floor((remaining / 1000) % 60);

        document.getElementById("timer").innerText = `${minutes}m ${seconds}s`;
    }

    updateTimer();
    setInterval(updateTimer, 1000);
</script>
{% endif %}

<script>
// Scroll automático al final del chat
const chatBox = document.getElementById("chat-box");
if (chatBox) {
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Enviar con Enter
document.addEventListener("DOMContentLoaded", function() {
    const textarea = document.getElementById("answer-input");
    const form = document.getElementById("chat-form");

    if (textarea && form) {
        textarea.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault(); // no salto de línea
                form.submit();      // envía
            }
        });
    }
});
</script>
{% endblock %}